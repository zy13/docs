<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Promise原理解析与实现 | zy&#39;s docs</title>
    <meta name="description" content="Welcome!">
    <limk rel="icon" href="/docs/logo.png"></limk>
  <link rel="manifest" href="/docs/manifest.json">
  <meta name="theme-color" content="#ccc">
    
    <link rel="preload" href="/docs/assets/css/0.styles.8912bdf8.css" as="style"><link rel="preload" href="/docs/assets/js/app.acf4c017.js" as="script"><link rel="preload" href="/docs/assets/js/33.930d6f78.js" as="script"><link rel="prefetch" href="/docs/assets/js/68.0949f5a6.js"><link rel="prefetch" href="/docs/assets/js/1.6a2045ef.js"><link rel="prefetch" href="/docs/assets/js/2.b5f3db6a.js"><link rel="prefetch" href="/docs/assets/js/3.219f09ba.js"><link rel="prefetch" href="/docs/assets/js/4.8ee55220.js"><link rel="prefetch" href="/docs/assets/js/5.87cde8e5.js"><link rel="prefetch" href="/docs/assets/js/6.0e65e52f.js"><link rel="prefetch" href="/docs/assets/js/7.61916ad4.js"><link rel="prefetch" href="/docs/assets/js/8.c2320f88.js"><link rel="prefetch" href="/docs/assets/js/9.3939e875.js"><link rel="prefetch" href="/docs/assets/js/10.ab015975.js"><link rel="prefetch" href="/docs/assets/js/11.f26d0dbe.js"><link rel="prefetch" href="/docs/assets/js/12.a83b5e17.js"><link rel="prefetch" href="/docs/assets/js/13.3f4ce23b.js"><link rel="prefetch" href="/docs/assets/js/14.788d1837.js"><link rel="prefetch" href="/docs/assets/js/15.4578a994.js"><link rel="prefetch" href="/docs/assets/js/16.c88f046d.js"><link rel="prefetch" href="/docs/assets/js/17.bda3b65a.js"><link rel="prefetch" href="/docs/assets/js/18.f51293d6.js"><link rel="prefetch" href="/docs/assets/js/19.e23bdb82.js"><link rel="prefetch" href="/docs/assets/js/20.9a922dab.js"><link rel="prefetch" href="/docs/assets/js/21.2c6da050.js"><link rel="prefetch" href="/docs/assets/js/22.6118c2ea.js"><link rel="prefetch" href="/docs/assets/js/23.ce4cf644.js"><link rel="prefetch" href="/docs/assets/js/24.ae10fafa.js"><link rel="prefetch" href="/docs/assets/js/25.928437eb.js"><link rel="prefetch" href="/docs/assets/js/26.8cb0b9b6.js"><link rel="prefetch" href="/docs/assets/js/27.382eb8da.js"><link rel="prefetch" href="/docs/assets/js/28.17c15003.js"><link rel="prefetch" href="/docs/assets/js/29.d47780b1.js"><link rel="prefetch" href="/docs/assets/js/30.ca5d8646.js"><link rel="prefetch" href="/docs/assets/js/31.e97fc58f.js"><link rel="prefetch" href="/docs/assets/js/32.0c64de17.js"><link rel="prefetch" href="/docs/assets/js/34.6fecaaf4.js"><link rel="prefetch" href="/docs/assets/js/35.15ec5007.js"><link rel="prefetch" href="/docs/assets/js/36.111dbe33.js"><link rel="prefetch" href="/docs/assets/js/37.c2b3add1.js"><link rel="prefetch" href="/docs/assets/js/38.828abaf6.js"><link rel="prefetch" href="/docs/assets/js/39.734a24da.js"><link rel="prefetch" href="/docs/assets/js/40.e69160d7.js"><link rel="prefetch" href="/docs/assets/js/41.dd684a74.js"><link rel="prefetch" href="/docs/assets/js/42.309aa73e.js"><link rel="prefetch" href="/docs/assets/js/43.79668988.js"><link rel="prefetch" href="/docs/assets/js/44.167ed7a1.js"><link rel="prefetch" href="/docs/assets/js/45.70f35d40.js"><link rel="prefetch" href="/docs/assets/js/46.c9b62498.js"><link rel="prefetch" href="/docs/assets/js/47.8555fc5c.js"><link rel="prefetch" href="/docs/assets/js/48.ef9f36c4.js"><link rel="prefetch" href="/docs/assets/js/49.f36e6af6.js"><link rel="prefetch" href="/docs/assets/js/50.ce7d469f.js"><link rel="prefetch" href="/docs/assets/js/51.1bc4f677.js"><link rel="prefetch" href="/docs/assets/js/52.3ad516c7.js"><link rel="prefetch" href="/docs/assets/js/53.74e97523.js"><link rel="prefetch" href="/docs/assets/js/54.0fb41450.js"><link rel="prefetch" href="/docs/assets/js/55.2bafb766.js"><link rel="prefetch" href="/docs/assets/js/56.f7fc87ce.js"><link rel="prefetch" href="/docs/assets/js/57.e58e92d4.js"><link rel="prefetch" href="/docs/assets/js/58.e1315a5a.js"><link rel="prefetch" href="/docs/assets/js/59.2db26cda.js"><link rel="prefetch" href="/docs/assets/js/60.7d1dd448.js"><link rel="prefetch" href="/docs/assets/js/61.23f37ee9.js"><link rel="prefetch" href="/docs/assets/js/62.147ba493.js"><link rel="prefetch" href="/docs/assets/js/63.e7d1038b.js"><link rel="prefetch" href="/docs/assets/js/64.19b6fa3d.js"><link rel="prefetch" href="/docs/assets/js/65.46aa7ef7.js"><link rel="prefetch" href="/docs/assets/js/66.04d3893a.js"><link rel="prefetch" href="/docs/assets/js/67.178c9fba.js"><link rel="prefetch" href="/docs/assets/js/69.c2893f3a.js"><link rel="prefetch" href="/docs/assets/js/70.7a2a176e.js"><link rel="prefetch" href="/docs/assets/js/71.ba13bf2a.js"><link rel="prefetch" href="/docs/assets/js/72.9a0ab200.js"><link rel="prefetch" href="/docs/assets/js/73.932aa523.js"><link rel="prefetch" href="/docs/assets/js/74.8e601453.js"><link rel="prefetch" href="/docs/assets/js/75.50d34247.js"><link rel="prefetch" href="/docs/assets/js/76.42fcca85.js"><link rel="prefetch" href="/docs/assets/js/77.209afa80.js"><link rel="prefetch" href="/docs/assets/js/78.e6a098a4.js"><link rel="prefetch" href="/docs/assets/js/79.df755869.js"><link rel="prefetch" href="/docs/assets/js/80.8485996a.js"><link rel="prefetch" href="/docs/assets/js/81.e1346e6c.js"><link rel="prefetch" href="/docs/assets/js/82.b6a82fab.js"><link rel="prefetch" href="/docs/assets/js/83.3a0aad16.js"><link rel="prefetch" href="/docs/assets/js/84.db8784c0.js"><link rel="prefetch" href="/docs/assets/js/85.b577b1a5.js"><link rel="prefetch" href="/docs/assets/js/86.dc089bcc.js"><link rel="prefetch" href="/docs/assets/js/87.18718c47.js"><link rel="prefetch" href="/docs/assets/js/88.45a535b3.js"><link rel="prefetch" href="/docs/assets/js/89.f4403f46.js"><link rel="prefetch" href="/docs/assets/js/90.88b43a93.js"><link rel="prefetch" href="/docs/assets/js/91.8da65492.js"><link rel="prefetch" href="/docs/assets/js/92.4feea20b.js"><link rel="prefetch" href="/docs/assets/js/93.d45ed88a.js"><link rel="prefetch" href="/docs/assets/js/94.9d832728.js"><link rel="prefetch" href="/docs/assets/js/95.b3dfb83f.js"><link rel="prefetch" href="/docs/assets/js/96.656fee38.js"><link rel="prefetch" href="/docs/assets/js/97.6eff8f66.js"><link rel="prefetch" href="/docs/assets/js/98.9f0e66bc.js"><link rel="prefetch" href="/docs/assets/js/99.032bfecd.js"><link rel="prefetch" href="/docs/assets/js/100.737761ad.js"><link rel="prefetch" href="/docs/assets/js/101.6970e95d.js"><link rel="prefetch" href="/docs/assets/js/102.74d9d087.js"><link rel="prefetch" href="/docs/assets/js/103.b7e392a0.js"><link rel="prefetch" href="/docs/assets/js/104.41a49370.js"><link rel="prefetch" href="/docs/assets/js/105.1019523a.js"><link rel="prefetch" href="/docs/assets/js/106.73b7319e.js"><link rel="prefetch" href="/docs/assets/js/107.9f2f6271.js"><link rel="prefetch" href="/docs/assets/js/108.77620658.js"><link rel="prefetch" href="/docs/assets/js/109.a2956b0d.js"><link rel="prefetch" href="/docs/assets/js/110.23a3ce76.js"><link rel="prefetch" href="/docs/assets/js/111.4ccc0dde.js"><link rel="prefetch" href="/docs/assets/js/112.30932a5c.js"><link rel="prefetch" href="/docs/assets/js/113.14372203.js"><link rel="prefetch" href="/docs/assets/js/114.752dee54.js"><link rel="prefetch" href="/docs/assets/js/115.b6e134e2.js"><link rel="prefetch" href="/docs/assets/js/116.5f0b7e73.js"><link rel="prefetch" href="/docs/assets/js/117.2e438b40.js"><link rel="prefetch" href="/docs/assets/js/118.7bc71357.js"><link rel="prefetch" href="/docs/assets/js/119.7a632ac0.js"><link rel="prefetch" href="/docs/assets/js/120.4fa561c7.js"><link rel="prefetch" href="/docs/assets/js/121.6fea8d64.js"><link rel="prefetch" href="/docs/assets/js/122.1dcd7eb4.js"><link rel="prefetch" href="/docs/assets/js/123.748e1cfa.js"><link rel="prefetch" href="/docs/assets/js/124.fb88d2ce.js"><link rel="prefetch" href="/docs/assets/js/125.30c58dc4.js"><link rel="prefetch" href="/docs/assets/js/126.4928e376.js"><link rel="prefetch" href="/docs/assets/js/127.e4004279.js"><link rel="prefetch" href="/docs/assets/js/128.58004c99.js"><link rel="prefetch" href="/docs/assets/js/129.25166f4c.js"><link rel="prefetch" href="/docs/assets/js/130.ab0b2d61.js"><link rel="prefetch" href="/docs/assets/js/131.cf363208.js"><link rel="prefetch" href="/docs/assets/js/132.b3ccf5bc.js"><link rel="prefetch" href="/docs/assets/js/133.193edc8a.js"><link rel="prefetch" href="/docs/assets/js/134.a208587f.js"><link rel="prefetch" href="/docs/assets/js/135.fd1e63d4.js"><link rel="prefetch" href="/docs/assets/js/136.86a1f4c5.js"><link rel="prefetch" href="/docs/assets/js/137.4291ce53.js"><link rel="prefetch" href="/docs/assets/js/138.28634585.js"><link rel="prefetch" href="/docs/assets/js/139.fc7f3ea7.js"><link rel="prefetch" href="/docs/assets/js/140.c0ed5f14.js"><link rel="prefetch" href="/docs/assets/js/141.679ce97c.js"><link rel="prefetch" href="/docs/assets/js/142.78e11f14.js"><link rel="prefetch" href="/docs/assets/js/143.7162ae6a.js"><link rel="prefetch" href="/docs/assets/js/144.872d5b44.js"><link rel="prefetch" href="/docs/assets/js/145.d4440db9.js"><link rel="prefetch" href="/docs/assets/js/146.11b5e61f.js"><link rel="prefetch" href="/docs/assets/js/147.5904dff6.js"><link rel="prefetch" href="/docs/assets/js/148.40256055.js"><link rel="prefetch" href="/docs/assets/js/149.96a4a846.js"><link rel="prefetch" href="/docs/assets/js/150.95d5f63c.js"><link rel="prefetch" href="/docs/assets/js/151.f623d9c2.js"><link rel="prefetch" href="/docs/assets/js/152.bdda962f.js"><link rel="prefetch" href="/docs/assets/js/153.6277a739.js"><link rel="prefetch" href="/docs/assets/js/154.4fa949c9.js"><link rel="prefetch" href="/docs/assets/js/155.a2861ac9.js"><link rel="prefetch" href="/docs/assets/js/156.ba791bf0.js"><link rel="prefetch" href="/docs/assets/js/157.82f5bd05.js"><link rel="prefetch" href="/docs/assets/js/158.d00242c1.js"><link rel="prefetch" href="/docs/assets/js/159.f6b62543.js"><link rel="prefetch" href="/docs/assets/js/160.f7691c52.js"><link rel="prefetch" href="/docs/assets/js/161.5de90b23.js"><link rel="prefetch" href="/docs/assets/js/162.ac6d4c38.js"><link rel="prefetch" href="/docs/assets/js/163.e43bf690.js"><link rel="prefetch" href="/docs/assets/js/164.fd225455.js"><link rel="prefetch" href="/docs/assets/js/165.33faf5d8.js"><link rel="prefetch" href="/docs/assets/js/166.43c39690.js"><link rel="prefetch" href="/docs/assets/js/167.f60f53cf.js"><link rel="prefetch" href="/docs/assets/js/168.0377ea50.js"><link rel="prefetch" href="/docs/assets/js/169.f2bf444d.js"><link rel="prefetch" href="/docs/assets/js/170.637798a1.js"><link rel="prefetch" href="/docs/assets/js/171.4d9edaa7.js"><link rel="prefetch" href="/docs/assets/js/172.20a017d5.js"><link rel="prefetch" href="/docs/assets/js/173.229ef695.js"><link rel="prefetch" href="/docs/assets/js/174.1d341fad.js"><link rel="prefetch" href="/docs/assets/js/175.ff21c2fa.js"><link rel="prefetch" href="/docs/assets/js/176.58bdd20d.js"><link rel="prefetch" href="/docs/assets/js/177.4b6e419c.js"><link rel="prefetch" href="/docs/assets/js/178.c38eacae.js"><link rel="prefetch" href="/docs/assets/js/179.2102ca04.js"><link rel="prefetch" href="/docs/assets/js/180.0acc8e12.js"><link rel="prefetch" href="/docs/assets/js/181.1191a3b6.js"><link rel="prefetch" href="/docs/assets/js/182.854004ca.js"><link rel="prefetch" href="/docs/assets/js/183.0a0e5b66.js"><link rel="prefetch" href="/docs/assets/js/184.8d8015dc.js"><link rel="prefetch" href="/docs/assets/js/185.1bab7135.js"><link rel="prefetch" href="/docs/assets/js/186.028e62aa.js"><link rel="prefetch" href="/docs/assets/js/187.9c630c62.js"><link rel="prefetch" href="/docs/assets/js/188.9e84d370.js"><link rel="prefetch" href="/docs/assets/js/189.a30ad706.js"><link rel="prefetch" href="/docs/assets/js/190.c8eedc5c.js"><link rel="prefetch" href="/docs/assets/js/191.bb2173bd.js"><link rel="prefetch" href="/docs/assets/js/192.2ce27902.js"><link rel="prefetch" href="/docs/assets/js/193.d991abd1.js"><link rel="prefetch" href="/docs/assets/js/194.b4413a9a.js"><link rel="prefetch" href="/docs/assets/js/195.92e73aa3.js"><link rel="prefetch" href="/docs/assets/js/196.adc1244a.js"><link rel="prefetch" href="/docs/assets/js/197.746b2621.js"><link rel="prefetch" href="/docs/assets/js/198.7b75e1dc.js"><link rel="prefetch" href="/docs/assets/js/199.813641d3.js"><link rel="prefetch" href="/docs/assets/js/200.29bcba4f.js"><link rel="prefetch" href="/docs/assets/js/201.10afeca4.js"><link rel="prefetch" href="/docs/assets/js/202.e6442c0a.js"><link rel="prefetch" href="/docs/assets/js/203.78d9f101.js"><link rel="prefetch" href="/docs/assets/js/204.11c2c1a6.js"><link rel="prefetch" href="/docs/assets/js/205.abddd1a3.js"><link rel="prefetch" href="/docs/assets/js/206.956e1f42.js"><link rel="prefetch" href="/docs/assets/js/207.4299c1ed.js"><link rel="prefetch" href="/docs/assets/js/208.4559c4e3.js"><link rel="prefetch" href="/docs/assets/js/209.7831ea49.js"><link rel="prefetch" href="/docs/assets/js/210.6c8328c6.js"><link rel="prefetch" href="/docs/assets/js/211.15e4b810.js"><link rel="prefetch" href="/docs/assets/js/212.462bf149.js"><link rel="prefetch" href="/docs/assets/js/213.78fd74e8.js"><link rel="prefetch" href="/docs/assets/js/214.d1299a62.js"><link rel="prefetch" href="/docs/assets/js/215.bb04e4d4.js"><link rel="prefetch" href="/docs/assets/js/216.98d1168a.js"><link rel="prefetch" href="/docs/assets/js/217.ac94712a.js"><link rel="prefetch" href="/docs/assets/js/218.b1f0aba6.js"><link rel="prefetch" href="/docs/assets/js/219.8ce0675a.js"><link rel="prefetch" href="/docs/assets/js/220.7186b642.js"><link rel="prefetch" href="/docs/assets/js/221.2383e08f.js"><link rel="prefetch" href="/docs/assets/js/222.0d7d0baa.js">
    <link rel="stylesheet" href="/docs/assets/css/0.styles.8912bdf8.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div><a href="/docs/" class="home-link router-link-active"><!----><span class="site-name">
      zy's docs
    </span></a><div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""><!----></div><nav class="nav-links can-hide"><div class="nav-item"><a href="/docs/kkb/" class="nav-link router-link-active">高级前端</a></div><div class="nav-item"><a href="/docs/resource/" class="nav-link">前端资源</a></div><div class="nav-item"><a href="/docs/javascript/" class="nav-link">JavaScript深入简出</a></div><div class="nav-item"><a href="/docs/javascript-wd/" class="nav-link">JavaScript教程-网道</a></div><div class="nav-item"><a href="/docs/http/" class="nav-link">HTTP权威指南</a></div><!----></nav></div></header><div class="sidebar-mask"></div><div class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="/docs/kkb/" class="nav-link router-link-active">高级前端</a></div><div class="nav-item"><a href="/docs/resource/" class="nav-link">前端资源</a></div><div class="nav-item"><a href="/docs/javascript/" class="nav-link">JavaScript深入简出</a></div><div class="nav-item"><a href="/docs/javascript-wd/" class="nav-link">JavaScript教程-网道</a></div><div class="nav-item"><a href="/docs/http/" class="nav-link">HTTP权威指南</a></div><!----></nav><ul class="sidebar-links"><li><div class="sidebar-group first collapsable"><p class="sidebar-heading"><span>第一章 ECMAScript6基础</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>第二章 面向对象编程</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>第四章 正则表达式</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading open"><span>第五章 ES6高阶函数</span><span class="arrow down"></span></p><ul class="sidebar-group-items"><li><a href="/docs/kkb/5-es6-higher/1-async.html" class="sidebar-link">第1节 异步专题</a></li><li><a href="/docs/kkb/5-es6-higher/2-data.html" class="sidebar-link">第2节 数据响应式原理</a></li><li><a href="/docs/kkb/5-es6-higher/3-promise.html" class="active sidebar-link">第3节 Promise原理</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/docs/kkb/5-es6-higher/3-promise.html#_1、promise介绍" class="sidebar-link">1、Promise介绍</a></li><li class="sidebar-sub-header"><a href="/docs/kkb/5-es6-higher/3-promise.html#_2、promise-三种状态" class="sidebar-link">2、Promise 三种状态</a></li><li class="sidebar-sub-header"><a href="/docs/kkb/5-es6-higher/3-promise.html#_3、resolve-方法" class="sidebar-link">3、resolve 方法</a></li><li class="sidebar-sub-header"><a href="/docs/kkb/5-es6-higher/3-promise.html#_4、reject-方法" class="sidebar-link">4、reject 方法</a></li><li class="sidebar-sub-header"><a href="/docs/kkb/5-es6-higher/3-promise.html#_5、then-方法" class="sidebar-link">5、then 方法</a></li><li class="sidebar-sub-header"><a href="/docs/kkb/5-es6-higher/3-promise.html#_3、任务执行顺序" class="sidebar-link">3、任务执行顺序</a></li><li class="sidebar-sub-header"><a href="/docs/kkb/5-es6-higher/3-promise.html#_7、静态方法-resolve-和-reject" class="sidebar-link">7、静态方法 resolve() 和 reject()</a></li><li class="sidebar-sub-header"><a href="/docs/kkb/5-es6-higher/3-promise.html#_8、静态方法-race" class="sidebar-link">8、静态方法 race()</a></li><li class="sidebar-sub-header"><a href="/docs/kkb/5-es6-higher/3-promise.html#_9、静态方法-all" class="sidebar-link">9、静态方法 all()</a></li><li class="sidebar-sub-header"><a href="/docs/kkb/5-es6-higher/3-promise.html#_10、静态方法allsettled-es2020" class="sidebar-link">10、静态方法allSettled()-ES2020</a></li><li class="sidebar-sub-header"><a href="/docs/kkb/5-es6-higher/3-promise.html#_11、方法-finally" class="sidebar-link">11、方法 finally()</a></li><li class="sidebar-sub-header"><a href="/docs/kkb/5-es6-higher/3-promise.html#_12、方法-catch" class="sidebar-link">12、方法 catch()</a></li><li class="sidebar-sub-header"><a href="/docs/kkb/5-es6-higher/3-promise.html#_13、静态方法-any-es2021" class="sidebar-link">13、静态方法 any()- ES2021</a></li><li class="sidebar-sub-header"><a href="/docs/kkb/5-es6-higher/3-promise.html#_14、扩展-mutationobserver-微任务" class="sidebar-link">14、扩展-MutationObserver-微任务</a></li><li class="sidebar-sub-header"><a href="/docs/kkb/5-es6-higher/3-promise.html#_15、完整代码" class="sidebar-link">15、完整代码</a></li></ul></li></ul></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>第六章 Git</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>第七章 函数式编程</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>第八章 Node.js</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>第九章 前后端交互</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>第十章 客户端存储</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>第十一章 webpack</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>第十二章 TypeScript</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>第十三章 Vue</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>第十四章 React</span><span class="arrow right"></span></p><!----></div></li><li><div class="sidebar-group collapsable"><p class="sidebar-heading"><span>第十八章 移动端专题</span><span class="arrow right"></span></p><!----></div></li></ul></div><div class="page"><div class="content"><h1 id="promise原理解析与实现"><a href="#promise原理解析与实现" aria-hidden="true" class="header-anchor">#</a> Promise原理解析与实现</h1><h3 id="要点"><a href="#要点" aria-hidden="true" class="header-anchor">#</a> 要点</h3><ul><li>Promise 类</li><li>Promise 状态</li><li>promise.resolve 方法实现</li><li>promise.reject 方法实现</li><li>promise.then 方法实现</li><li>promise.catch 方法实现</li></ul><h3 id="目标"><a href="#目标" aria-hidden="true" class="header-anchor">#</a> 目标</h3><ul><li>了解 <code>Promise</code> 基本实现原理</li><li>深入掌握 <code>Promise</code> 的使用细节</li><li>了解 <code>Promise</code> 未来新标准新特性</li></ul><h3 id="学前须知"><a href="#学前须知" aria-hidden="true" class="header-anchor">#</a> 学前须知</h3><p>本次 <code>Promise</code> 源码课程中会涉及到面向对象的使用，所以如果您能知道一些面向对象的知识（基础即可），会更加有利于您的理解</p><h2 id="_1、promise介绍"><a href="#_1、promise介绍" aria-hidden="true" class="header-anchor">#</a> 1、Promise介绍</h2><p><code>Promise</code> 是 <code>JavaScript</code> 异步编程的一种流行解决方案，掌握 <code>Promise</code> 的使用是我们不可或缺的一项基本技能。但是要想熟练掌握并深入的理解它，还是必须要知道它的实现原理的。这节课就是从具体使用角度出发，使用原生手写方式一步一步的带你实现 <code>Promise</code> 库，而且不仅仅只是包含了 <code>Promise</code> 目前通用的功能，还有 <code>Promise</code> 的一些新的特性和未来即将支持的特性的介绍与实现</p><h3 id="promise-类"><a href="#promise-类" aria-hidden="true" class="header-anchor">#</a> Promise 类</h3><p><code>Promise</code> 的构造函数必须接收一个函数参数（也就是需要执行异步任务的函数），该函数将在传入以后立即调用，并传入 <code>Promise</code> 对象下的两个方法 <code>resolve</code> 和 <code>reject</code></p><ul><li>Promose接受一个函数，函数会立即执行，函数传入两个参数为Promise对象下的
<ul><li><strong>Promise.resolve</strong>方法</li><li><strong>Promise.reject</strong>方法</li></ul></li></ul><h3 id="promise方法"><a href="#promise方法" aria-hidden="true" class="header-anchor">#</a> Promise方法</h3><ul><li>Promise.prototype.then()</li><li>Promise.prototype.catch()</li><li>Promise.prototype.finally()</li><li>Promise.all()</li><li>Promise.race()</li><li>Promise.allSettled()</li><li>Promise.any()</li><li>Promise.resolve()</li><li>Promise.reject()</li></ul><h2 id="_2、promise-三种状态"><a href="#_2、promise-三种状态" aria-hidden="true" class="header-anchor">#</a> 2、Promise 三种状态</h2><p>每一个 <code>Promise</code> 对象都存在以下<strong>三种状态</strong>：</p><ul><li><code>pending</code> : 进行中 - 初始状态</li><li><code>fulfilled</code> : 已成功</li><li><code>rejected</code> : 已失败</li></ul><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">class</span> <span class="token class-name">Promise</span><span class="token punctuation">{</span>
  <span class="token function">constructor</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token string">'[[PromiseState]]'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'pending'</span>
    <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token string">'[[PromiseResult]]'</span><span class="token punctuation">]</span> <span class="token operator">=</span> undefined
    <span class="token function">handle</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_resolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_reject<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token function">_resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.改变状态 2、改变value</span>
    <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token string">'[[PromiseState]]'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'fulfilled'</span>
    <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token string">'[[PromiseResult]]'</span><span class="token punctuation">]</span> <span class="token operator">=</span> val
  <span class="token punctuation">}</span>
  <span class="token function">_reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// 1.改变状态 2、改变value</span>
    <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token string">'[[PromiseState]]'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'rejected'</span>
    <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token string">'[[PromiseResult]]'</span><span class="token punctuation">]</span> <span class="token operator">=</span> err
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 实例化</span>
<span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'成功'</span><span class="token punctuation">)</span>
  <span class="token comment">// reject('失败')</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>p<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><strong>注意</strong></p><ul><li>每一个 <code>Promise</code> 对象只能由 <code>pending</code> 状态变成 <code>fulfilled</code> 或 <code>rejected</code></li><li>状态发生变化以后就不能再改变了</li><li>一个 <code>Promise</code> 对象状态的变化并不由 <code>Promise</code> 对象本身来决定，而应该是由我们传入的异步任务完成情况来决定的</li><li><code>Promise</code> 提供了两个用来改变状态的方法，resolve, reject</li></ul><h2 id="_3、resolve-方法"><a href="#_3、resolve-方法" aria-hidden="true" class="header-anchor">#</a> 3、resolve 方法</h2><ul><li><p>将 <code>Promise</code> 对象的状态从 <code>pending</code> 变为 <code>fulfilled</code>，并执行成功后的注册任务;</p></li><li><p>修改<code>PromiseResult</code>的值为实例化对象传过来的对象</p></li><li><p>注意：如果当前状态已经改变过了，则直接 <code>return</code></p></li></ul><div class="language-js extra-class"><pre class="language-js"><code><span class="token function">_resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token string">'[[PromiseState]]'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'fulfilled'</span>
  <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token string">'[[PromiseResult]]'</span><span class="token punctuation">]</span> <span class="token operator">=</span> val
  <span class="token comment">// 微任务-所有同步任务执行后才开始执行微任务</span>
  <span class="token keyword">let</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> cb
    <span class="token keyword">while</span> <span class="token punctuation">(</span>cb <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resolveFnQueue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">cb</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> mo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span>
  mo<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">,</span><span class="token punctuation">{</span>
    attributes<span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'kkb'</span><span class="token punctuation">,</span> <span class="token string">'kkb'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_4、reject-方法"><a href="#_4、reject-方法" aria-hidden="true" class="header-anchor">#</a> 4、reject 方法</h2><ul><li><p>将 <code>Promise</code> 对象的状态从 <code>pending</code> 变为 <code>rejected</code>，并执行失败后的注册任务;</p></li><li><p>修改<code>PromiseResult</code>的值为实例化对象传过来的对象</p></li><li><p>注意：如果当前状态已经改变过了，则直接 <code>return</code></p></li></ul><div class="language-js extra-class"><pre class="language-js"><code><span class="token function">_reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token string">'[[PromiseState]]'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'rejected'</span>
  <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token string">'[[PromiseResult]]'</span><span class="token punctuation">]</span> <span class="token operator">=</span> err
  <span class="token comment">// 微任务-所有同步任务执行后才开始执行微任务</span>
  <span class="token keyword">let</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> cb
    <span class="token keyword">while</span> <span class="token punctuation">(</span>cb <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rejectFnQueue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> mo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span>
  mo<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">,</span><span class="token punctuation">{</span>
    attributes<span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'kkb'</span><span class="token punctuation">,</span> <span class="token string">'kkb'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_5、then-方法"><a href="#_5、then-方法" aria-hidden="true" class="header-anchor">#</a> 5、then 方法</h2><p><code>then</code> 方法用来获取结果，它接收两个函数作为参数，分别注册到 <code>resolve</code> 和 <code>reject</code>  方法执行后的任务队列中;</p><ul><li>then是个异步任务，分为宏任务和微任务：
<ul><li>比如setTimeout是个宏任务，其特点是：颗粒比较大</li><li>在宏任务后面建立微任务队列，执行完之后才会执行下一个宏任务</li><li>微任务颗粒度小，先执行，宏任务颗粒度大，后执行</li></ul></li></ul><div class="language-js extra-class"><pre class="language-js"><code><span class="token function">then</span><span class="token punctuation">(</span>onResolve<span class="token punctuation">,</span> onReject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// then原则：只存储回调函数，不执行回调函数</span>
  <span class="token comment">// 链式调用</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> <span class="token function-variable function">onResolveFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> res <span class="token operator">=</span> onResolve <span class="token operator">&amp;&amp;</span> <span class="token function">onResolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
      <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span>
      <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">let</span> <span class="token function-variable function">onRejectFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>resolveFnQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onResolveFn<span class="token punctuation">)</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>rejectFnQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onReject<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_1、添加任务"><a href="#_1、添加任务" aria-hidden="true" class="header-anchor">#</a> 1、添加任务</h3><p>把 <code>then</code> 方法中接收到的两个函数分别添加到对应的<strong>任务队列</strong>中：</p><ul><li><strong>fulfilledQueues -- resolveFnQueue</strong></li><li><strong>rejectedQueues -- rejectedFnQueue</strong></li></ul><div class="language-js extra-class"><pre class="language-js"><code>  <span class="token function">then</span><span class="token punctuation">(</span>onResolve<span class="token punctuation">,</span> onRejected<span class="token punctuation">)</span><span class="token punctuation">{</span>
    <span class="token comment">// 链式调用：后一个then获取前一个then的返回值</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> <span class="token function-variable function">onResolveFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> res <span class="token operator">=</span> onResolve <span class="token operator">&amp;&amp;</span> <span class="token function">onResolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token keyword">instanceof</span> <span class="token class-name">MyPromise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span>
        <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">let</span> <span class="token function-variable function">rejectedFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        onRejected <span class="token operator">&amp;&amp;</span> <span class="token function">onRejected</span><span class="token punctuation">(</span><span class="token punctuation">)</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>resolveFnQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onResolveFn<span class="token punctuation">)</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>rejectedFnQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>rejectedFn<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
</code></pre></div><h3 id="_2、执行任务"><a href="#_2、执行任务" aria-hidden="true" class="header-anchor">#</a> 2、执行任务</h3><p>在 <code>Promise.resolve</code> 和 <code>Promise.reject</code> 方法中调用执行对应的任务队列的所有注册函数</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// === 改善后 === </span>
<span class="token function">_resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token comment">// 1.改变状态 2、改变value</span>
  <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token string">'[[PromiseState]]'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'fulfilled'</span>
  <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token string">'[[PromiseResult]]'</span><span class="token punctuation">]</span> <span class="token operator">=</span> val
  <span class="token comment">// 模拟微任务</span>
  <span class="token keyword">let</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> cb<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>cb <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resolveFnQueue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">cb</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> mo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span>
  mo<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">,</span><span class="token punctuation">{</span>
    attributes<span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'kkb'</span><span class="token punctuation">,</span><span class="token string">'kkb'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
<span class="token function">_reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token string">'[[PromiseState]]'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'rejected'</span>
  <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token string">'[[PromiseResult]]'</span><span class="token punctuation">]</span> <span class="token operator">=</span> err
  <span class="token comment">// 模拟微任务</span>
  <span class="token keyword">let</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> cb<span class="token punctuation">;</span>
    <span class="token keyword">while</span><span class="token punctuation">(</span>cb <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rejectedFnQueue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">let</span> mo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span>
  mo<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">,</span><span class="token punctuation">{</span>
    attributes<span class="token punctuation">:</span> <span class="token boolean">true</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
  document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'kkb'</span><span class="token punctuation">,</span><span class="token string">'kkb'</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h3 id="_3、结果传递"><a href="#_3、结果传递" aria-hidden="true" class="header-anchor">#</a> 3、结果传递</h3><p>在调用 <code>reslove</code> 或者 <code>reject</code> 方法的时候，我们还可以通过传入一些值，在后续的 <code>then</code> 方法中，可以通过对应的函数接收到该结果</p><blockquote><p>如果在一个 <code>Promise</code> 对象的状态改变后调用<code>then</code> 则会立即执行添加的对应函数，所以需要注意必须根据当前 <code>Promise</code> 的状态来做不同的处理</p><ul><li>PENDING : 添加到对应的任务队列</li><li>FULFILLED / REJECTED : 不用添加到队列，而是立即执行任务</li></ul></blockquote><h3 id="返回值"><a href="#返回值" aria-hidden="true" class="header-anchor">#</a> 返回值</h3><p><code>then</code> 方法在执行最后必须返回一个新的 <code>Promise</code> 对象</p><blockquote><p><span style="color:red">重点（难点）</span></p><p>返回 <code>Promise</code>对象会立即调用并执行，如果这个时候，直接去执行该对象的 <code>resolve</code> 或者 <code>reject</code> 方法都会导致后续的 <code>then</code> 也立即被调用</p><p>我们需要对原 <code>fulfilledHandler</code> 和 <code>rejectedHandler</code> 进行包装，把它们和新 <code>Promise</code> 对象的 <code>resolve</code> 和 <code>reject</code> 方法分别放置到新的函数中，并把这个新的函数添加到原有任务队列中调用</p><p>简而言之：把新返回的 <code>Promise</code> 对象的 <code>resolve</code> 和 <code>reject</code> 与 <code>then</code> 中执行的 <code>fulfilledHandler</code> 和 <code>rejectedHandler</code> 添加到一个任务队列中执行，这样才能使用原有的 <code>then</code> 执行完成以后才执行新的 <code>Promise</code> 中的 <code>then</code></p></blockquote><p>上面是默认情况下的处理情况，其实 <code>then</code> 方法的处理更为复杂</p><blockquote><p>当一个<a href="https://developer.mozilla.org/zh-CN/docs/Web/JavaScript/Reference/Global_Objects/Promise" target="_blank" rel="noopener noreferrer"><code>Promise</code><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>完成（fulfilled）或者失败（rejected），返回函数将被异步调用（由当前的线程循环来调度完成）。具体的返回值依据以下规则返回：</p><ul><li>如果then中的回调函数没有返回值，那么then返回的Promise将会成为接受状态，并且该接受状态的回调函数的参数值为 undefined。</li><li>如果then中的回调函数返回一个值，那么then返回的Promise将会成为接受状态，并且将返回的值作为接受状态的回调函数的参数值。</li><li>如果then中的回调函数抛出一个错误，那么then返回的Promise将会成为拒绝状态，并且将抛出的错误作为拒绝状态的回调函数的参数值。</li><li>如果then中的回调函数返回一个已经是接受状态的Promise，那么then返回的Promise也会成为接受状态，并且将那个Promise的接受状态的回调函数的参数值作为该被返回的Promise的接受状态回调函数的参数值。</li><li>如果then中的回调函数返回一个已经是拒绝状态的Promise，那么then返回的Promise也会成为拒绝状态，并且将那个Promise的拒绝状态的回调函数的参数值作为该被返回的Promise的拒绝状态回调函数的参数值。</li><li>如果then中的回调函数返回一个未定状态（pending）的Promise，那么then返回Promise的状态也是未定的，并且它的终态与那个Promise的终态相同；同时，它变为终态时调用的回调函数参数与那个Promise变为终态时的回调函数的参数是相同的。</li></ul></blockquote><h2 id="_3、任务执行顺序"><a href="#_3、任务执行顺序" aria-hidden="true" class="header-anchor">#</a> 3、任务执行顺序</h2><p>所有<code>&lt;script&gt;</code>标签是一个大的宏任务，分好同步队列和异步队列，同步任务放进同步队列，异步任务放进异步任务，同步队列的任务执行完之后，再执行异步任务。而异步任务包括宏任务和微任务，其中所有微任务按顺序执行完，再按顺序执行宏任务，比如<code>setTimeout</code>。</p><ul><li><strong>微任务</strong><ul><li><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/MutationObserver" target="_blank" rel="noopener noreferrer">MutationObserver<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>监视对DOM树的更改</li><li><code>Promise.then</code></li></ul></li><li><strong>宏任务</strong><ul><li><code>&lt;script&gt;</code>标签：同步任务放在同步队列，异步任务放在异步队列
<ul><li>异步任务包括宏任务和微任务。</li></ul></li><li><code>setTimeout</code>、<code>setIntterval</code></li></ul></li></ul><p><strong>标签<code>&lt;script&gt;</code>中的事件执行中，同步、异步执行顺序</strong></p><p>-- <img src="/docs/assets/img/task-queue.drawio.c5b3ce59.png" alt="image"></p><p><strong>标签<code>&lt;script&gt;</code>中的事件循环，异步任务分为宏任务、微任务的执行顺序</strong></p><p>-- <img src="/docs/assets/img/event-loop.drawio.71188def.png" alt="image"></p><p><strong>下面任务执行顺序：同步 -&gt; 异步 （微任务）-&gt; 异步宏任务</strong></p><ul><li>1、先执行同步任务：<code>console.log(111)--&gt;console.log('执行')--&gt;console.log(222)--&gt; console.log(333) --&gt;console.log('我是第二个script标签')--&gt;console.log('第二-111')--&gt;console.log('弟2 - 333')</code></li><li>2、再执行异步微任务：<code>console.log(111, res) --&gt; console.log(2) --&gt; console.log('第二-111')--&gt;console.log('弟2 - 222', res)</code></li><li>3、再执行异步宏任务：<code>setTimeout: console.log('setTimeout')</code></li></ul><div class="language-html extra-class"><pre class="language-html"><code>  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript">
    <span class="token comment">// 宏任务 - 异步任务</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token keyword">function</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'setTimeout'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// Promise不是严格意义的微任务</span>
    <span class="token keyword">let</span> p <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'执行'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'成功'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token comment">// then是微任务</span>
    p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>err<span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">222</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    p<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">2</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token number">333</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
  <span class="token tag"><span class="token tag"><span class="token punctuation">&lt;</span>script</span><span class="token punctuation">&gt;</span></span><span class="token script language-javascript">
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'我是第二个script标签'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">let</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve<span class="token operator">=&gt;</span><span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'第二-111'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token string">'第2 promise'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    p2<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'弟2 - 222'</span><span class="token punctuation">,</span> res<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'弟2 - 333'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  </span><span class="token tag"><span class="token tag"><span class="token punctuation">&lt;/</span>script</span><span class="token punctuation">&gt;</span></span>
</code></pre></div><h2 id="_7、静态方法-resolve-和-reject"><a href="#_7、静态方法-resolve-和-reject" aria-hidden="true" class="header-anchor">#</a> 7、静态方法 resolve() 和 reject()</h2><div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">static</span> <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span>resolve <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>
  <span class="token keyword">static</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>undifined<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span>  
</code></pre></div><h2 id="_8、静态方法-race"><a href="#_8、静态方法-race" aria-hidden="true" class="header-anchor">#</a> 8、静态方法 race()</h2><p>Promise.race()方法将多个 Promise 实例，包装成一个新的 Promise 实例。</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token comment">// 只要p1、p2之中有一个实例率先改变状态，p的状态就跟着改变。</span>
<span class="token comment">// 那个率先改变的 Promise 实例的返回值，就传递给p的回调函数。</span>
<span class="token keyword">let</span> p1 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">222</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">2000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token keyword">let</span> p2 <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  <span class="token function">setTimeout</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token operator">=&gt;</span><span class="token punctuation">{</span>
    <span class="token function">resolve</span><span class="token punctuation">(</span><span class="token number">111</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span> <span class="token number">1000</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
Promise<span class="token punctuation">.</span><span class="token function">race</span><span class="token punctuation">(</span><span class="token punctuation">[</span>p1<span class="token punctuation">,</span>p2<span class="token punctuation">]</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
  console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span><span class="token punctuation">;</span> <span class="token comment">// 111</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span>
</code></pre></div><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">static</span> <span class="token function">race</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">MyPromise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span><span class="token punctuation">;</span>
    list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      item<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> err <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_9、静态方法-all"><a href="#_9、静态方法-all" aria-hidden="true" class="header-anchor">#</a> 9、静态方法 all()</h2><p><code>all()</code>方法接受一个数组，用于将多个 Promise 实例，包装成一个新的 Promise 实例:</p><div class="language- extra-class"><pre class="language-text"><code>const p = Promise.all([p1, p2, p3]);
</code></pre></div><ul><li>只有p1、p2、p3的状态都变成fulfilled，p的状态才会变成fulfilled。p1、p2、p3的返回值组成一个数组，传递给p的回调函数。</li><li>只要p1、p2、p3之中有一个被rejected，p的状态就变成rejected，此时第一个被reject的实例的返回值，会传递给p的回调函数。</li></ul><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">static</span> <span class="token function">all</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    <span class="token keyword">let</span> resArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
    <span class="token keyword">let</span> num <span class="token operator">=</span> <span class="token number">0</span>
    list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      item<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        num<span class="token operator">++</span>
        resArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>num <span class="token operator">===</span> resArr<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>resArr<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> err <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_10、静态方法allsettled-es2020"><a href="#_10、静态方法allsettled-es2020" aria-hidden="true" class="header-anchor">#</a> 10、静态方法allSettled()-ES2020</h2><p>Promise.allSettled()方法方法接受一组 Promise 实例作为参数，包装成一个新的 Promise 实例。只有等到所有这些参数实例都返回结果，不管是<code>fulfilled</code>还是<code>rejected</code>，包装实例才会结束。</p><div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">static</span> <span class="token function">allSettled</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">let</span> resArr <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">Array</span><span class="token punctuation">(</span>list<span class="token punctuation">.</span>length<span class="token punctuation">)</span>
  <span class="token keyword">let</span> num <span class="token operator">=</span> <span class="token number">0</span>
  <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span>item<span class="token punctuation">,</span>key<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
      <span class="token keyword">let</span> obj <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token punctuation">}</span>
      item<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        obj<span class="token punctuation">[</span><span class="token string">'state'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token string">'[[PromiseState]]'</span><span class="token punctuation">]</span> 
        obj<span class="token punctuation">[</span><span class="token string">'value'</span><span class="token punctuation">]</span> <span class="token operator">=</span> res
        resArr<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> obj
        num<span class="token operator">++</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>num<span class="token operator">===</span>list<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>resArr<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">,</span> err<span class="token operator">=&gt;</span><span class="token punctuation">{</span>
        obj<span class="token punctuation">[</span><span class="token string">'state'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token string">'[[PromiseState]]'</span><span class="token punctuation">]</span> 
        obj<span class="token punctuation">[</span><span class="token string">'value'</span><span class="token punctuation">]</span> <span class="token operator">=</span> err
        resArr<span class="token punctuation">[</span>key<span class="token punctuation">]</span> <span class="token operator">=</span> obj
        num<span class="token operator">++</span>
        <span class="token keyword">if</span><span class="token punctuation">(</span>num<span class="token operator">===</span>list<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">{</span>
          <span class="token function">resolve</span><span class="token punctuation">(</span>resArr<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_11、方法-finally"><a href="#_11、方法-finally" aria-hidden="true" class="header-anchor">#</a> 11、方法 finally()</h2><p>异步执行完成之后在执行</p><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">finally</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_12、方法-catch"><a href="#_12、方法-catch" aria-hidden="true" class="header-anchor">#</a> 12、方法 catch()</h2><div class="language-js extra-class"><pre class="language-js"><code><span class="token keyword">catch</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>undefined<span class="token punctuation">,</span> err<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
    cb <span class="token operator">&amp;&amp;</span> <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token punctuation">)</span>
<span class="token punctuation">}</span>
</code></pre></div><h2 id="_13、静态方法-any-es2021"><a href="#_13、静态方法-any-es2021" aria-hidden="true" class="header-anchor">#</a> 13、静态方法 any()- ES2021</h2><p>该方法接受一组 Promise 实例作为参数，包装成一个新的 Promise 实例返回。只要参数实例有一个变成fulfilled状态，包装实例就会变成fulfilled状态；如果所有参数实例都变成rejected状态，包装实例就会变成rejected状态。</p><h2 id="_14、扩展-mutationobserver-微任务"><a href="#_14、扩展-mutationobserver-微任务" aria-hidden="true" class="header-anchor">#</a> 14、扩展-MutationObserver-微任务</h2><p><a href="https://developer.mozilla.org/zh-CN/docs/Web/API/MutationObserver/MutationObserver" target="_blank" rel="noopener noreferrer">MutationObserver<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>创建并返回一个新的观察器，它会在触发指定 DOM 事件时，调用指定的回调函数。MutationObserver 对 DOM 的观察不会立即启动；而必须先调用 observe() 方法来确定，要监听哪一部分的 DOM 以及要响应哪些更改。</p><ul><li>语法</li></ul><p><code>var observer = new MutationObserver(callback);</code></p><ul><li>微任务</li></ul><p>由<code>MutationObserver</code>的实例化对象是一个<a href="https://developer.mozilla.org/zh-CN/docs/Web/API/HTML_DOM_API/Microtask_guide" target="_blank" rel="noopener noreferrer">微任务<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path><polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>，属于异步任务的一部分，只有所有同步任务执行完，才会执行异步任务。异步任务中可以有很多宏任务和微任务，微任务执行完之后才会执行下一个宏任务。</p><p><img src="/docs/assets/img/event-loop.drawio.71188def.png" alt="img"></p><h2 id="_15、完整代码"><a href="#_15、完整代码" aria-hidden="true" class="header-anchor">#</a> 15、完整代码</h2><div class="language-js extra-class"><pre class="language-js"><code>  <span class="token keyword">class</span> <span class="token class-name">Promise</span><span class="token punctuation">{</span>
    <span class="token function">constructor</span><span class="token punctuation">(</span>handle<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token string">'[[PromiseState]]'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'pending'</span>
      <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token string">'[[PromiseResult]]'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'undefined'</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span>resolveFnQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>      
      <span class="token keyword">this</span><span class="token punctuation">.</span>rejectFnQueue <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
      <span class="token function">handle</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">.</span>_resolve<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">this</span><span class="token punctuation">.</span>_reject<span class="token punctuation">.</span><span class="token function">bind</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">_resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token string">'[[PromiseState]]'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'fulfilled'</span>
      <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token string">'[[PromiseResult]]'</span><span class="token punctuation">]</span> <span class="token operator">=</span> val
      <span class="token comment">// 微任务-所有同步任务执行后才开始执行微任务</span>
      <span class="token keyword">let</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> cb
        <span class="token keyword">while</span> <span class="token punctuation">(</span>cb <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>resolveFnQueue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">cb</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">let</span> mo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span>
      mo<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">,</span><span class="token punctuation">{</span>
        attributes<span class="token punctuation">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'kkb'</span><span class="token punctuation">,</span> <span class="token string">'kkb'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">_reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token string">'[[PromiseState]]'</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">'rejected'</span>
      <span class="token keyword">this</span><span class="token punctuation">[</span><span class="token string">'[[PromiseResult]]'</span><span class="token punctuation">]</span> <span class="token operator">=</span> err
      <span class="token comment">// 微任务-所有同步任务执行后才开始执行微任务</span>
      <span class="token keyword">let</span> <span class="token function-variable function">run</span> <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> cb
        <span class="token keyword">while</span> <span class="token punctuation">(</span>cb <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">.</span>rejectFnQueue<span class="token punctuation">.</span><span class="token function">shift</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
          <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
      <span class="token punctuation">}</span>
      <span class="token keyword">let</span> mo <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">MutationObserver</span><span class="token punctuation">(</span>run<span class="token punctuation">)</span>
      mo<span class="token punctuation">.</span><span class="token function">observe</span><span class="token punctuation">(</span>document<span class="token punctuation">.</span>body<span class="token punctuation">,</span><span class="token punctuation">{</span>
        attributes<span class="token punctuation">:</span> <span class="token boolean">true</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
      document<span class="token punctuation">.</span>body<span class="token punctuation">.</span><span class="token function">setAttribute</span><span class="token punctuation">(</span><span class="token string">'kkb'</span><span class="token punctuation">,</span> <span class="token string">'kkb'</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token function">then</span><span class="token punctuation">(</span>onResolve<span class="token punctuation">,</span> onReject<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// then原则：只存储回调函数，不执行回调函数</span>
      <span class="token comment">// 链式调用</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> <span class="token function-variable function">onResolveFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token keyword">let</span> res <span class="token operator">=</span> onResolve <span class="token operator">&amp;&amp;</span> <span class="token function">onResolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
          <span class="token keyword">if</span><span class="token punctuation">(</span>res <span class="token keyword">instanceof</span> <span class="token class-name">Promise</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            res<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>resolve<span class="token punctuation">)</span>
          <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
            <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
          <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">let</span> <span class="token function-variable function">onRejectFn</span> <span class="token operator">=</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>resolveFnQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onResolveFn<span class="token punctuation">)</span>
        <span class="token keyword">this</span><span class="token punctuation">.</span>rejectFnQueue<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>onReject<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">static</span> <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span>resolve <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">resolve</span><span class="token punctuation">(</span>val<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">static</span> <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>undefined<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">static</span> <span class="token function">all</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token comment">// 所有函数都resolve才返回的结果列表</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> resArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          item<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            resArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>resArr<span class="token punctuation">.</span>length <span class="token operator">===</span> list<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">resolve</span><span class="token punctuation">(</span>resArr<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span>err <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span><span class="token string">'err'</span><span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">static</span> <span class="token function">allSettled</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span> reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        <span class="token keyword">let</span> resArr <span class="token operator">=</span> <span class="token punctuation">[</span><span class="token punctuation">]</span>
        list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          item<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            resArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>resArr<span class="token punctuation">.</span>length <span class="token operator">===</span> list<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">resolve</span><span class="token punctuation">(</span>resArr<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span> err <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            resArr<span class="token punctuation">.</span><span class="token function">push</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
            <span class="token keyword">if</span><span class="token punctuation">(</span>resArr<span class="token punctuation">.</span>length <span class="token operator">===</span> list<span class="token punctuation">.</span>length<span class="token punctuation">)</span> <span class="token punctuation">{</span>
              <span class="token function">resolve</span><span class="token punctuation">(</span>resArr<span class="token punctuation">)</span>
            <span class="token punctuation">}</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">static</span> <span class="token function">race</span><span class="token punctuation">(</span>list<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">Promise</span><span class="token punctuation">(</span><span class="token punctuation">(</span>resolve<span class="token punctuation">,</span>reject<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        list<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span>item <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
          item<span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>res <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
              <span class="token function">resolve</span><span class="token punctuation">(</span>res<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">,</span> err <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
            <span class="token function">reject</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
          <span class="token punctuation">}</span><span class="token punctuation">)</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">finally</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">catch</span><span class="token punctuation">(</span>cb<span class="token punctuation">)</span> <span class="token punctuation">{</span>
      <span class="token keyword">this</span><span class="token punctuation">.</span><span class="token function">then</span><span class="token punctuation">(</span><span class="token punctuation">(</span>undefined<span class="token punctuation">,</span> err<span class="token punctuation">)</span> <span class="token operator">=&gt;</span> <span class="token punctuation">{</span>
        cb <span class="token operator">&amp;&amp;</span> <span class="token function">cb</span><span class="token punctuation">(</span>err<span class="token punctuation">)</span>
      <span class="token punctuation">}</span><span class="token punctuation">)</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span>
</code></pre></div></div><div class="page-edit"><!----><!----></div><div class="page-nav"><p class="inner"><span class="prev">
        ← <a href="/docs/kkb/5-es6-higher/2-data.html" class="prev">
          第2节 数据响应式原理
        </a></span><span class="next"><a href="/docs/kkb/8-nodejs/1-webServer.html">
          第1节 搭建webServer
        </a> →
      </span></p></div></div></div></div>
    <script src="/docs/assets/js/33.930d6f78.js" defer></script><script src="/docs/assets/js/app.acf4c017.js" defer></script>
  </body>
</html>
